#!/bin/sh

set -e

#    -e      Encrypt files with recipient's GPG key

usage(){
    cat << EOF
Usage: pgpmail [OPTION]... -f FILE... -r RECIPIENT

REQUIRED:
    -f FILE     Path to file to include in email as attachment
    -r TO       Recipient of email

OPTIONS:
    -c          Include checksum of files in email
    -h          Display this message and exit
    -s FROM         Sender of email
EOF
    exit 0
}

verify_files(){
    # Verifies the files specified are indeed files
    for file in $FILES; do
        if [ ! -f "$file" ]; then
            echo "$0: '$file' not found"
            usage
        fi
    done
}

generate_attachments(){
    for file in $FILES; do
        ATTACHMENTS="${ATTACHMENTS} -A $file"
    done
    ATTACHMENTS="${ATTACHMENTS#?}"
}

hash_files(){
    # Loops through every file specified and appends a hash for each to a list
    for FILE in "$FILES"; do
        HASHES="${HASHES} $(sha256sum $FILE)"
    done
    HASHES="${HASHES#?}"
}

send_email(){
    # TODO: Write documentation about following error:
    #
    # send-mail: fatal: open /etc/postfix/main.cf: No such file or directory
    # Can't send mail: sendmail process failed with error code 75
    #
    # For me, `postfix` wasn't setup properly.
    [ ! "$(command -v mail 2>/dev/null)" ] && echo "$0: mailutils is not installed" && exit 1
    [ ! "$RECIPIENT" ] && echo "$0: no recipient specified" && usage
    [ "$HASH" ] && hash_files; echo "$HASHES" | mail \
        -s "$SUBJECT" \
        `[ "$SENDER" ] && echo  " -r $SENDER"` \
        `[ "$FILES" ] && verify_files && generate_attachments && echo "$ATTACHMENTS"` \
        "$RECIPIENT" 
}

SUBJECT="$(date) pgpmail"

while getopts cf:hr:s: arg; do
    case "$arg" in
        c) HASH=1 ;;
        f) FILES="${FILES} $OPTARG" ;;
        h) usage ;;
        r) RECIPIENT="$OPTARG" ;;
        s) SENDER="$OPTARG" ;;
        ?) usage ;;
    esac
done

FILES="${FILES#?}"

send_email
